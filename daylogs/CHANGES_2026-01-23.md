# Changes - January 23, 2026

## Summary of Changes

### 1. **io.py** - Enhanced DICOM Loading
- **Fixed DICOM file detection**: Now recursively searches directories using `os.walk()` and attempts to read ALL files as DICOM regardless of extension
- **Added `force=True` parameter**: Uses `pydicom.dcmread(path, force=True)` for better compatibility with non-standard DICOM files
- **Added TransferSyntaxUID setting**: Sets `ds.file_meta.TransferSyntaxUID = pydicom.uid.ImplicitVRLittleEndian` for improved compatibility
- **Timestamp-based sorting**: Extracts `AcquisitionTime`, `AcquisitionDateTime`, `SeriesTime`, or `ContentTime` and sorts slices chronologically (reverse order)
- **Better error reporting**: Shows count of files checked, first 3 errors, and improved error messages
- **Debug output**: Prints slice order with timestamps for verification

### 2. **analysis.py** - Fixed Slice Loading and Center Detection
- **Fixed slice loading bug**: All `run_*()` methods now properly load slices from DICOM series even when `use_slice_averaging=False`
  - Each method checks `if self.dicom_series is not None` and loads appropriate slice
  - Handles both averaging and non-averaging modes correctly
- **Fixed spacing handling**: Added proper fallback for missing spacing in `run_uniformity()` (now consistent with other methods)
- **Fixed coordinate ordering**: Corrected center coordinates in `run_high_contrast()` and `run_ctp401()` to use `(cx, cy)` format instead of `(cy, cx)`
- **Improved center detection**: Changed threshold from 50th to 75th percentile in `_estimate_center()` for more accurate phantom detection
- **Removed default cropping**: Changed `run_ctp515()` default crop values from 150 to 0 pixels (no cropping by default)

### 3. **ctp401_analyzer.py** - Rotation Detection
- **New method**: `detect_rotation()` - Automatically detects phantom rotation using air ROI positions
  - Finds top and bottom air ROIs at 90° and -90° from center
  - Uses interpolated profiles to precisely locate air ROI centers
  - Iteratively refines positions (3 iterations)
  - Calculates rotation angle: `rotation = -arctan((top_x - bottom_x) / (top_y - bottom_y))`
- **Added imports**: `scipy.ndimage`, `scipy.interpolate.interpn`, `scipy.signal.find_peaks`

### 4. **analysis.py** - Rotation Integration Across Modules
- **Updated `run_ctp401()`**:
  - New parameters: `t_offset=None`, `detect_rotation=True`
  - Automatically detects rotation if `t_offset` not provided
  - Stores rotation angle in `self.results['rotation_angle']`
  - Prints detected rotation angle
  - Applies rotation offset to all material ROI positions

- **Updated `run_high_contrast()`**:
  - New parameter: `t_offset=None`
  - Automatically uses `rotation_angle` from results if available
  - Prints message when using detected rotation
  - Passes rotation offset to `HighContrastAnalyzer` via `t_offset_deg` parameter

- **Updated `run_ctp515()`**:
  - New parameter: `angle_offset=None`
  - Automatically uses `rotation_angle` from results if available
  - Fallback to 0.0° (not -7.5°) if no rotation detected
  - Prints message when using detected rotation
  - Applies rotation to low-contrast ROI positioning

### 5. **cli.py** - Enhanced Plotting Behavior
- **Added `--show-plot` flag**: Controls whether plots are displayed interactively
- **Changed default behavior for `full_analysis`**:
  - Plots are **saved by default** to current directory (or `--save-plot` path if specified)
  - Plots are **NOT displayed** unless `--show-plot` is used
  - Properly closes figures with `plt.close(fig)` when not showing
- **For individual modules**: Plots only save/show if explicitly requested with flags

### 6. **Documentation Updates**
- **CLI_USAGE.md**:
  - Added `--show-plot` flag to options list
  - Updated examples to show new plotting behavior
  - Clarified that `full_analysis --plot` saves without displaying by default
  - Added section for "Save Plots Without Displaying"
  
- **README.md**:
  - Updated quick start examples to show `--show-plot` flag usage
  - Added example for saving plots to directory

## Architecture Impact

### Rotation Detection Workflow
The package now automatically detects and applies phantom rotation:

1. **Detection**: `run_ctp401()` detects rotation using air ROI positions (CTP401 module)
2. **Storage**: Rotation angle stored in `self.results['rotation_angle']`
3. **Propagation**: Subsequent modules (`run_high_contrast`, `run_ctp515`) automatically use detected rotation
4. **Override**: Manual rotation offsets can still be provided via parameters

### Plotting Behavior
- **full_analysis mode**: Saves plots automatically, displays only if `--show-plot` used
- **Individual modules**: Requires explicit `--save-plot` and/or `--show-plot` flags
- Prevents blocking behavior in automated workflows while maintaining interactive capability

## Bug Fixes

1. **DICOM loading failure**: Fixed issue where non-standard file extensions prevented DICOM loading
2. **NoneType error**: Fixed crash when `self.image` was None in DICOM series mode without averaging
3. **Spacing crash**: Fixed `'NoneType' object is not subscriptable` error in `run_uniformity()`
4. **Center coordinate mismatch**: Fixed inconsistent (x,y) vs (y,x) coordinate ordering across modules
5. **Center detection accuracy**: Improved phantom center detection with higher threshold percentile

## Key Features Added

- **Automatic rotation detection** using air ROI positions in CTP401 module
- **Rotation propagation** across all analysis modules (high_contrast, ctp515)
- **Robust DICOM loading** that handles any file extension and non-standard DICOM files
- **Timestamp-based slice ordering** for correct chronological sequence
- **Non-blocking plot saving** for automated workflows (full_analysis mode)
- **Interactive plot display** via `--show-plot` flag when needed

## Breaking Changes

**None** - All changes maintain backward compatibility:
- Rotation detection is enabled by default but can be disabled
- Plotting behavior for individual modules unchanged (requires explicit flags)
- Manual rotation offsets still work via parameters

## Usage Examples

**Automatic rotation detection and correction:**
```bash
# Full analysis with automatic rotation detection
catphan404 -m full_analysis --plot
# Saves plots, uses detected rotation for all modules

# Display plots interactively
catphan404 -m full_analysis --plot --show-plot

# Manual rotation override
catphan404 -m ctp401 --plot
# In code: analyzer.run_ctp401(t_offset=2.5)
```

**Programmatic usage:**
```python
analyzer = Catphan404Analyzer(dicom_series=series)

# Rotation detected automatically and propagated
analyzer.run_ctp401()          # Detects rotation (e.g., 2.3°)
analyzer.run_high_contrast()   # Uses 2.3° rotation
analyzer.run_ctp515()          # Uses 2.3° rotation

# Access rotation angle
rotation = analyzer.results['rotation_angle']  # 2.3
```
